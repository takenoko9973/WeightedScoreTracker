name: Release Windows App (Cross-compile)

on:
    push:
        tags:
            - "v*"

jobs:
    build-and-release:
        name: Build for Windows (on Linux)
        runs-on: ubuntu-latest

        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # 1. MinGW-w64 (クロスコンパイラ) のインストール
            - name: Install MinGW-w64
              run: |
                  sudo apt-get update
                  sudo apt-get install -y mingw-w64

            # 2. Rustターゲットの追加 (Windows-GNU)
            - name: Setup Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: x86_64-pc-windows-gnu

            - name: Rust cache
              uses: swatinem/rust-cache@v2

            # 3. ビルド実行 (ターゲット指定)
            - name: Build
              run: cargo build --release --target x86_64-pc-windows-gnu --verbose

            # 4. exeファイルのリネーム (Bashを使用)
            - name: Rename executable
              shell: bash
              run: |
                  # タグ名 (v1.0.0など)
                  TAG_NAME="${GITHUB_REF_NAME}"

                  # クロスコンパイルの出力先ディレクトリ
                  TARGET_DIR="target/x86_64-pc-windows-gnu/release"

                  # exeファイルを探す (ディレクトリ内の最初の .exe)
                  EXE_PATH=$(find "$TARGET_DIR" -maxdepth 1 -name "*.exe" | head -n 1)

                  if [ -n "$EXE_PATH" ]; then
                    FILENAME=$(basename "$EXE_PATH")
                    BASENAME="${FILENAME%.*}"
                    NEW_NAME="${BASENAME}_${TAG_NAME}.exe"
                    NEW_PATH="$TARGET_DIR/$NEW_NAME"

                    mv "$EXE_PATH" "$NEW_PATH"
                    echo "Renamed $FILENAME to $NEW_NAME"

                    # GITHUB_ENVにパスを保存
                    echo "ASSET_PATH=$NEW_PATH" >> $GITHUB_ENV
                  else
                    echo "Error: Executable file not found in $TARGET_DIR"
                    exit 1
                  fi

            # 5. リリース作成
            - name: Create Release
              uses: softprops/action-gh-release@v2
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  files: ${{ env.ASSET_PATH }}
                  generate_release_notes: true
                  draft: false
                  prerelease: false
